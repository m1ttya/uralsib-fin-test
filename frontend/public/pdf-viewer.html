<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF Viewer</title>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { height: 100%; overflow: auto; background: #fff; }
    .page { margin: 12px auto; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,.1); border: 1px solid rgba(0,0,0,.08); border-radius: 6px; overflow: hidden; width: min(900px, 96%); }
    .spinner { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(255,255,255,.6); color: #555; font-size: 14px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="spinner" class="spinner hidden">Загрузка PDF…</div>
  <script type="module">
    import * as pdfjsLib from 'https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@4.6.82/build/pdf.worker.min.mjs';

    const params = new URLSearchParams(location.search);
    const file = params.get('file');
    const app = document.getElementById('app');
    const spinner = document.getElementById('spinner');

    async function main() {
      if (!file) {
        app.textContent = 'Не указан файл (?file=URL)';
        return;
      }
      spinner.classList.remove('hidden');
      try {
        const loadingTask = pdfjsLib.getDocument({ url: file, withCredentials: true });
        const pdfDoc = await loadingTask.promise;
        const total = pdfDoc.numPages;
        const dpr = Math.min(window.devicePixelRatio || 1, 2);

        for (let i = 1; i <= total; i++) {
          const page = await pdfDoc.getPage(i);
          const viewport = page.getViewport({ scale: 1 });
          const targetW = Math.min(900, window.innerWidth * 0.96);
          const scale = targetW / viewport.width;
          const scaled = page.getViewport({ scale });

          const pageEl = document.createElement('div');
          pageEl.className = 'page';
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.style.width = scaled.width + 'px';
          canvas.style.height = scaled.height + 'px';
          canvas.width = Math.floor(scaled.width * dpr);
          canvas.height = Math.floor(scaled.height * dpr);
          pageEl.appendChild(canvas);
          app.appendChild(pageEl);
          if (!ctx) continue;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          await page.render({ canvasContext: ctx, viewport: scaled }).promise;
        }
      } catch (e) {
        app.textContent = 'Не удалось загрузить PDF: ' + (e?.message || e);
      } finally {
        spinner.classList.add('hidden');
      }
    }

    main();
  </script>
</body>
</html>
